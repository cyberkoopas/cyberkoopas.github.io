<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[Hackday qualif] Crypto - Trusted | CyberKoopas</title>
<meta name="keywords" content="x-hackday-qualification, crypto">
<meta name="description" content="Challenge information Summary The situation is bad. The magistrate database from the Sagittarius sector has been leaked! The incident response team continues to see unknown connections in the logs from outside the sector, even though the passwords have all been changed. We suspect the problem is with the authentication portal&hellip; Do something about it!
Attached files server.py #!/usr/bin/env python3 import hashlib from random import randbytes def MAC(msg, key): return hashlib.sha256(key &#43; msg).">
<meta name="author" content="

">
<link rel="canonical" href="https://www.cyberkoopas.fr/posts/hackday-qualification/trusted/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css" integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://www.cyberkoopas.fr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.cyberkoopas.fr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.cyberkoopas.fr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://www.cyberkoopas.fr/apple-touch-icon.png">
<link rel="mask-icon" href="https://www.cyberkoopas.fr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="[Hackday qualif] Crypto - Trusted" />
<meta property="og:description" content="Challenge information Summary The situation is bad. The magistrate database from the Sagittarius sector has been leaked! The incident response team continues to see unknown connections in the logs from outside the sector, even though the passwords have all been changed. We suspect the problem is with the authentication portal&hellip; Do something about it!
Attached files server.py #!/usr/bin/env python3 import hashlib from random import randbytes def MAC(msg, key): return hashlib.sha256(key &#43; msg)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cyberkoopas.fr/posts/hackday-qualification/trusted/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-03-13T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[Hackday qualif] Crypto - Trusted"/>
<meta name="twitter:description" content="Challenge information Summary The situation is bad. The magistrate database from the Sagittarius sector has been leaked! The incident response team continues to see unknown connections in the logs from outside the sector, even though the passwords have all been changed. We suspect the problem is with the authentication portal&hellip; Do something about it!
Attached files server.py #!/usr/bin/env python3 import hashlib from random import randbytes def MAC(msg, key): return hashlib.sha256(key &#43; msg)."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://www.cyberkoopas.fr/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "[Hackday qualif] Crypto - Trusted",
      "item": "https://www.cyberkoopas.fr/posts/hackday-qualification/trusted/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[Hackday qualif] Crypto - Trusted",
  "name": "[Hackday qualif] Crypto - Trusted",
  "description": "Challenge information Summary The situation is bad. The magistrate database from the Sagittarius sector has been leaked! The incident response team continues to see unknown connections in the logs from outside the sector, even though the passwords have all been changed. We suspect the problem is with the authentication portal\u0026hellip; Do something about it!\nAttached files server.py #!/usr/bin/env python3 import hashlib from random import randbytes def MAC(msg, key): return hashlib.sha256(key + msg).",
  "keywords": [
    "x-hackday-qualification", "crypto"
  ],
  "articleBody": "Challenge information Summary The situation is bad. The magistrate database from the Sagittarius sector has been leaked! The incident response team continues to see unknown connections in the logs from outside the sector, even though the passwords have all been changed. We suspect the problem is with the authentication portal… Do something about it!\nAttached files server.py #!/usr/bin/env python3 import hashlib from random import randbytes def MAC(msg, key): return hashlib.sha256(key + msg).hexdigest() secret = randbytes(32) example = \"my_login\" mac_example = MAC(example.encode(), secret) banner = f\"\"\" _____ _ _ |_ _| | | | | | |_ __ _ _ ___| |_ ___ __| | | | '__| | | / __| __/ _ \\/ _` | | | | | |_| \\__ \\ || __/ (_| | \\_/_| \\__,_|___/\\__\\___|\\__,_| Welcome to the magistrates' systems authentication portal. These systems contain confidential information. By authenticating, you accept our terms of usage and confidentiality policy. On a first line, please send your login. On a second line, send the MAC of the login. Here's an example: \u003e {example} \u003e {mac_example} \"\"\" print(banner) login = input(\"\u003e \").encode(\"utf-8\", \"surrogateescape\") mac = input(\"\u003e \") if b\"admin\" not in login: print(\"User not recognized.\") exit(1) if mac != MAC(login, secret): print(\"Login error, the MAC is invalid.\") exit(1) with open(\"flag.txt\") as flag: print(\"Welcome, dear magistrate.\", flag.read()) Solution Implementation analysis Firstly, we can analyze the server script to understand how it works.\ndef MAC(msg, key): return hashlib.sha256(key + msg).hexdigest() The MAC() function return the hash of a secret key concatenated with the message.\nsecret = randbytes(32) The secret is randomly generated at each startup of the script.\nexample = \"my_login\" mac_example = MAC(example.encode(), secret) print(banner) login = input(\"\u003e \").encode(\"utf-8\", \"surrogateescape\") mac = input(\"\u003e \") The program show an example with a msg my_login and its signature.\nif b\"admin\" not in login: print(\"User not recognized.\") exit(1) if mac != MAC(login, secret): print(\"Login error, the MAC is invalid.\") exit(1) with open(\"flag.txt\") as flag: print(\"Welcome, dear magistrate.\", flag.read()) To access to the flag we need to cover 2 conditions :\nLogin string must contains admin. Provided signature must be valid. Now let’s enumerate to what we have access :\nThe my_login string signature. The secret length. Hash algorithm. admin in login and a valid signature are conditions to get the flag. Exploitation A technique called hash length extension affect the sha256 algorithm and it’s the vulnerability that we’ll exploit. In a nutshell, sha256 algorithm will process the first block of 64 bytes and then with the result, it will process the second block of 64 bytes. We can conclude that it’s possible to add extra information (by adding a new block), and get a valid signature by using the previous block’s signature. You got it ?\nSo the exploitation will takes place in 2 steps :\nCreate a login string containing admin in an additional block. Calculate the new hash based on the hash provided by the program (without the extra block). A great tool to help us is hash extender, it will provides us the new login string to send and its corresponding signature. Let’s generate a login string (containing admin).\n./hash_extender -d \"my_login\" -s \"a5d45f6a900dfd40c75711f1491023751a7ae7fa7af397a1d7bbe9c1d884d7fd\" -a \"admin\" -f sha256 -l 32 --out-data-format=hex # New string: 6d795f6c6f67696e80000000000000000000000000000000000000000000014061646d696e Now we can write a script : exploit.py\n#! /usr/bin/python3 import socket def netcat(hostname, port): s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.connect((hostname, port)) data = s.recv(1024) response = data.decode(\"utf-8\") print(\"Received:\", response) s.sendall(b\"\\x6d\\x79\\x5f\\x6c\\x6f\\x67\\x69\\x6e\\x80\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\x40\\x61\\x64\\x6d\\x69\\x6e\\n\") data = s.recv(1024) response = repr(data.decode(\"utf-8\")) print(\"Received:\", response) a = input(\"Put the hash : \") s.sendall(str.encode(a+\"\\n\")) data = s.recv(1024) response = data.decode(\"utf-8\") print(\"Received:\", response) print(\"Connection closed.\") s.close() netcat(\"127.0.0.1\", 8080) Steps of the script :\nInitiate a connection with the server Send our login string Ask for signature and send it Display flag So we need to run the script, get the provided signature and put it in the hash_extender tool, then put the new signature to the script.\npython3 exploit.py # 188765ad85f236a72f83aec315f6ba21988a434bcfd211aa81e13d75d84d9fea # From hash_extender : New signature: af2a0dade477f27c19f833d37af9dc07bb460723dce95870dfbb497a82503869 af2a0dade477f27c19f833d37af9dc07bb460723dce95870dfbb497a82503869 # Welcome, dear magistrate.HACKDAY{REDACTED} # In other terminal to get the signature ./hash_extender -d \"my_login\" -s \"ffc2364919f308b71bd0857b31e2cf6f1177c7dfdfc681ed1b3f355d36db5dda\" -a \"admin\" -f sha256 -l 32 --out-data-format=hex # New signature: af2a0dade477f27c19f833d37af9dc07bb460723dce95870dfbb497a82503869 Resources Here is a french reference on the attack :\nhackndo’s article (French) ",
  "wordCount" : "696",
  "inLanguage": "en",
  "datePublished": "2023-03-13T00:00:00Z",
  "dateModified": "2023-03-13T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "CyberKoopas"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.cyberkoopas.fr/posts/hackday-qualification/trusted/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "CyberKoopas",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.cyberkoopas.fr/favicon.ico"
    }
  }
}
</script>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.cyberkoopas.fr/" accesskey="h" title="CyberKoopas (Alt + H)">
                <img src="https://www.cyberkoopas.fr/avatar.jpeg" alt="" aria-label="logo"
                    height="30">CyberKoopas</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.cyberkoopas.fr/timeline/" title="Timeline">
                    <span>Timeline</span>
                </a>
            </li>
            <li>
                <a href="https://www.cyberkoopas.fr/categories/writeups/" title="Writeups">
                    <span>Writeups</span>
                </a>
            </li>
            <li>
                <a href="https://www.cyberkoopas.fr/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://www.cyberkoopas.fr/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      [Hackday qualif] Crypto - Trusted
    </h1>
    <div class="post-meta"><span title='2023-03-13 00:00:00 +0000 UTC'>March 13, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;



</div>
  </header> 
  <div class="post-content"><h2 id="challenge-information">Challenge information<a hidden class="anchor" aria-hidden="true" href="#challenge-information">#</a></h2>
<h3 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h3>
<p>The situation is bad. The magistrate database from the Sagittarius sector has been leaked!
The incident response team continues to see unknown connections in the logs from outside the sector, even though the passwords have all been changed.
We suspect the problem is with the authentication portal&hellip; Do something about it!</p>
<h3 id="attached-files">Attached files<a hidden class="anchor" aria-hidden="true" href="#attached-files">#</a></h3>
<ul>
<li>server.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> randbytes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">MAC</span>(msg, key):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hashlib<span style="color:#f92672">.</span>sha256(key <span style="color:#f92672">+</span> msg)<span style="color:#f92672">.</span>hexdigest()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>secret <span style="color:#f92672">=</span> randbytes(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>example <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;my_login&#34;</span>
</span></span><span style="display:flex;"><span>mac_example <span style="color:#f92672">=</span> MAC(example<span style="color:#f92672">.</span>encode(), secret)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>banner <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> _____              _           _ 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_   _|            | |         | |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | |_ __ _   _ ___| |_ ___  __| |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | | &#39;__| | | / __| __/ _ \/ _` |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | | |  | |_| \__ \ ||  __/ (_| |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  \_/_|   \__,_|___/\__\___|\__,_|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Welcome to the magistrates&#39; systems authentication portal.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">These systems contain confidential information. By authenticating, you accept our terms of usage and confidentiality policy.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">On a first line, please send your login. On a second line, send the MAC of the login.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Here&#39;s an example:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt; </span><span style="color:#e6db74">{</span>example<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt; </span><span style="color:#e6db74">{</span>mac_example<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(banner)
</span></span><span style="display:flex;"><span>login <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;&gt; &#34;</span>)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-8&#34;</span>, <span style="color:#e6db74">&#34;surrogateescape&#34;</span>)
</span></span><span style="display:flex;"><span>mac <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;&gt; &#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;admin&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> login:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;User not recognized.&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> mac <span style="color:#f92672">!=</span> MAC(login, secret):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Login error, the MAC is invalid.&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;flag.txt&#34;</span>) <span style="color:#66d9ef">as</span> flag:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Welcome, dear magistrate.&#34;</span>, flag<span style="color:#f92672">.</span>read())
</span></span></code></pre></div><h2 id="solution">Solution<a hidden class="anchor" aria-hidden="true" href="#solution">#</a></h2>
<h3 id="implementation-analysis">Implementation analysis<a hidden class="anchor" aria-hidden="true" href="#implementation-analysis">#</a></h3>
<p>Firstly, we can analyze the server script to understand how it works.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">MAC</span>(msg, key):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hashlib<span style="color:#f92672">.</span>sha256(key <span style="color:#f92672">+</span> msg)<span style="color:#f92672">.</span>hexdigest()
</span></span></code></pre></div><p>The <code>MAC()</code> function return the hash of a secret key concatenated with the message.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>secret <span style="color:#f92672">=</span> randbytes(<span style="color:#ae81ff">32</span>)
</span></span></code></pre></div><p>The secret is randomly generated at each startup of the script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>example <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;my_login&#34;</span>
</span></span><span style="display:flex;"><span>mac_example <span style="color:#f92672">=</span> MAC(example<span style="color:#f92672">.</span>encode(), secret)
</span></span><span style="display:flex;"><span>print(banner)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>login <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;&gt; &#34;</span>)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-8&#34;</span>, <span style="color:#e6db74">&#34;surrogateescape&#34;</span>)
</span></span><span style="display:flex;"><span>mac <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;&gt; &#34;</span>)
</span></span></code></pre></div><p>The program show an example with a msg <code>my_login</code> and its signature.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;admin&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> login:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;User not recognized.&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> mac <span style="color:#f92672">!=</span> MAC(login, secret):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Login error, the MAC is invalid.&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;flag.txt&#34;</span>) <span style="color:#66d9ef">as</span> flag:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Welcome, dear magistrate.&#34;</span>, flag<span style="color:#f92672">.</span>read())
</span></span></code></pre></div><p>To access to the flag we need to cover 2 conditions :</p>
<ul>
<li>Login string must contains <code>admin</code>.</li>
<li>Provided signature must be valid.</li>
</ul>
<p>Now let&rsquo;s enumerate to what we have access :</p>
<ul>
<li>The <code>my_login</code> string signature.</li>
<li>The secret length.</li>
<li>Hash algorithm.</li>
<li><code>admin</code> in login and a valid signature are conditions to get the flag.</li>
</ul>
<h3 id="exploitation">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation">#</a></h3>
<p>A technique called <em>hash length extension</em> affect the sha256 algorithm and it&rsquo;s the vulnerability that we&rsquo;ll exploit.  <br>
In a nutshell, <em>sha256</em> algorithm will process the first block of 64 bytes and then with the result, it will process the second block of 64 bytes.
We can conclude that it&rsquo;s possible to add extra information (by adding a new block), and get a valid signature by using the previous block&rsquo;s signature. You got it ?</p>
<p>So the exploitation will takes place in 2 steps :</p>
<ol>
<li>Create a login string containing <code>admin</code> in an additional block.</li>
<li>Calculate the new hash based on the hash provided by the program (without the extra block).</li>
</ol>
<p>A great tool to help us is <a href="https://github.com/iagox86/hash_extender">hash extender</a>, it will provides us the new login string to send and its corresponding signature.  <br>
Let&rsquo;s generate a login string (containing <code>admin</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./hash_extender -d <span style="color:#e6db74">&#34;my_login&#34;</span> -s <span style="color:#e6db74">&#34;a5d45f6a900dfd40c75711f1491023751a7ae7fa7af397a1d7bbe9c1d884d7fd&#34;</span> -a <span style="color:#e6db74">&#34;admin&#34;</span> -f sha256 -l <span style="color:#ae81ff">32</span> --out-data-format<span style="color:#f92672">=</span>hex
</span></span><span style="display:flex;"><span><span style="color:#75715e"># New string: 6d795f6c6f67696e80000000000000000000000000000000000000000000014061646d696e</span>
</span></span></code></pre></div><p><img loading="lazy" src="/CTFs/Hackday-qualif/Crypto/Trusted/new_string.png" alt="New_string"  />
</p>
<p>Now we can write a script : <em>exploit.py</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#! /usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">netcat</span>(hostname, port):
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>connect((hostname, port))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Received:&#34;</span>, response)
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>sendall(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6d\x79\x5f\x6c\x6f\x67\x69\x6e\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x40\x61\x64\x6d\x69\x6e\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> repr(data<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Received:&#34;</span>, response)
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Put the hash : &#34;</span>)
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>sendall(str<span style="color:#f92672">.</span>encode(a<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Received:&#34;</span>, response)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Connection closed.&#34;</span>)
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>netcat(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">8080</span>)
</span></span></code></pre></div><p>Steps of the script :</p>
<ul>
<li>Initiate a connection with the server</li>
<li>Send our login string</li>
<li>Ask for signature and send it</li>
<li>Display flag</li>
</ul>
<p>So we need to run the script, get the provided signature and put it in the <em>hash_extender</em> tool, then put the new signature to the script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python3 exploit.py
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 188765ad85f236a72f83aec315f6ba21988a434bcfd211aa81e13d75d84d9fea</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># From hash_extender : New signature: af2a0dade477f27c19f833d37af9dc07bb460723dce95870dfbb497a82503869</span>
</span></span><span style="display:flex;"><span>af2a0dade477f27c19f833d37af9dc07bb460723dce95870dfbb497a82503869
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Welcome, dear magistrate.HACKDAY{REDACTED}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># In other terminal to get the signature</span>
</span></span><span style="display:flex;"><span>./hash_extender -d <span style="color:#e6db74">&#34;my_login&#34;</span> -s <span style="color:#e6db74">&#34;ffc2364919f308b71bd0857b31e2cf6f1177c7dfdfc681ed1b3f355d36db5dda&#34;</span> -a <span style="color:#e6db74">&#34;admin&#34;</span> -f sha256 -l <span style="color:#ae81ff">32</span> --out-data-format<span style="color:#f92672">=</span>hex
</span></span><span style="display:flex;"><span><span style="color:#75715e"># New signature: af2a0dade477f27c19f833d37af9dc07bb460723dce95870dfbb497a82503869</span>
</span></span></code></pre></div><p><img loading="lazy" src="/CTFs/Hackday-qualif/Crypto/Trusted/proof.png" alt="Proof"  />
</p>
<h3 id="resources">Resources<a hidden class="anchor" aria-hidden="true" href="#resources">#</a></h3>
<p>Here is a french reference on the attack :</p>
<ul>
<li><a href="https://beta.hackndo.com/hash-length-extension/">hackndo&rsquo;s article (French)</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://www.cyberkoopas.fr/tags/x-hackday-qualification/">x-hackday-qualification</a></li>
      <li><a href="https://www.cyberkoopas.fr/tags/crypto/">crypto</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; CyberKoopas | 2023</span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
