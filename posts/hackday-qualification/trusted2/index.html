<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[Hackday qualif] Crypto - Trusted 2 | CyberKoopas</title>
<meta name="keywords" content="x-hackday-qualification, crypto">
<meta name="description" content="Challenge information Summary Following the leak of an important database in the Sagittarius sector, it has been decided to rework the whole security of the information system. Make sure that the authentication portal is this time secured as it should be.
Attached files server.py #!/usr/bin/env python3 import hashlib from random import randrange from ecdsa import NIST256p, ecdsa G = NIST256p.generator order = G.order() priv = randrange(1, order) pub = G * priv pub = ecdsa.">
<meta name="author" content="

">
<link rel="canonical" href="https://www.cyberkoopas.fr/posts/hackday-qualification/trusted2/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css" integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://www.cyberkoopas.fr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.cyberkoopas.fr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.cyberkoopas.fr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://www.cyberkoopas.fr/apple-touch-icon.png">
<link rel="mask-icon" href="https://www.cyberkoopas.fr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="[Hackday qualif] Crypto - Trusted 2" />
<meta property="og:description" content="Challenge information Summary Following the leak of an important database in the Sagittarius sector, it has been decided to rework the whole security of the information system. Make sure that the authentication portal is this time secured as it should be.
Attached files server.py #!/usr/bin/env python3 import hashlib from random import randrange from ecdsa import NIST256p, ecdsa G = NIST256p.generator order = G.order() priv = randrange(1, order) pub = G * priv pub = ecdsa." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cyberkoopas.fr/posts/hackday-qualification/trusted2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-13T01:00:00+00:00" />
<meta property="article:modified_time" content="2023-03-13T01:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[Hackday qualif] Crypto - Trusted 2"/>
<meta name="twitter:description" content="Challenge information Summary Following the leak of an important database in the Sagittarius sector, it has been decided to rework the whole security of the information system. Make sure that the authentication portal is this time secured as it should be.
Attached files server.py #!/usr/bin/env python3 import hashlib from random import randrange from ecdsa import NIST256p, ecdsa G = NIST256p.generator order = G.order() priv = randrange(1, order) pub = G * priv pub = ecdsa."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://www.cyberkoopas.fr/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "[Hackday qualif] Crypto - Trusted 2",
      "item": "https://www.cyberkoopas.fr/posts/hackday-qualification/trusted2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[Hackday qualif] Crypto - Trusted 2",
  "name": "[Hackday qualif] Crypto - Trusted 2",
  "description": "Challenge information Summary Following the leak of an important database in the Sagittarius sector, it has been decided to rework the whole security of the information system. Make sure that the authentication portal is this time secured as it should be.\nAttached files server.py #!/usr/bin/env python3 import hashlib from random import randrange from ecdsa import NIST256p, ecdsa G = NIST256p.generator order = G.order() priv = randrange(1, order) pub = G * priv pub = ecdsa.",
  "keywords": [
    "x-hackday-qualification", "crypto"
  ],
  "articleBody": "Challenge information Summary Following the leak of an important database in the Sagittarius sector, it has been decided to rework the whole security of the information system. Make sure that the authentication portal is this time secured as it should be.\nAttached files server.py #!/usr/bin/env python3 import hashlib from random import randrange from ecdsa import NIST256p, ecdsa G = NIST256p.generator order = G.order() priv = randrange(1, order) pub = G * priv pub = ecdsa.Public_key(G, pub) priv = ecdsa.Private_key(pub, priv) k = randrange(1, 2 ** 127) banner = \"\"\" _____ _ _ ___ ___ |_ _| | | | | |__ \\ / _ \\ | |_ __ _ _ ___| |_ ___ __| | ) || | | | | | '__| | | / __| __/ _ \\/ _` | / / | | | | | | | | |_| \\__ \\ || __/ (_| | / /_ | |_| | \\_/_| \\__,_|___/\\__\\___|\\__,_| |____(_)___/ \"\"\" print(banner) welcome = f\"Welcome to the magistrates' systems authentication portal. These systems contain confidential information. By authenticating, you accept our terms of usage and confidentiality policy.\" welcome_sig = priv.sign(int(hashlib.sha256(welcome.encode()).hexdigest(), 16), k) challenge = \"All the information in this portal is signed so you can verify its authenticity. To authenticate, please send your login and then its signature.\" challenge_sig = priv.sign(int(hashlib.sha256(challenge.encode()).hexdigest(), 16), k) print(welcome) print((int(welcome_sig.r), int(welcome_sig.s))) print(challenge) print((int(challenge_sig.r), int(challenge_sig.s))) login = input(\"Login: \") user_r = input(\"r: \") user_s = input(\"s: \") try: flag_sig = ecdsa.Signature(int(user_r), int(user_s)) except: print(\"This is not a valid signature!\") exit(1) if login != \"admin\": print(\"User not recognized.\") exit(1) elif pub.verifies(int(hashlib.sha256(login.encode()).hexdigest(), 16), flag_sig): with open(\"flag.txt\", \"r\") as flag: print(\"Welcome back, magistrate.\", flag.read()) else: print(\"The signature does not match.\") Solution Implementation analysis Let’s analyze what the server do.\nimport hashlib from random import randrange from ecdsa import NIST256p, ecdsa G = NIST256p.generator order = G.order() priv = randrange(1, order) pub = G * priv pub = ecdsa.Public_key(G, pub) priv = ecdsa.Private_key(pub, priv) k = randrange(1, 2 ** 127) Here, we understand that the algorithm is ECDSA. There are :\nRandom number : priv. Random number : k. pub (we need priv to get it). Public number : order (always the same). welcome = f\"Welcome to the magistrates' systems authentication portal. These systems contain confidential information. By authenticating, you accept our terms of usage and confidentiality policy.\" welcome_sig = priv.sign(int(hashlib.sha256(welcome.encode()).hexdigest(), 16), k) challenge = \"All the information in this portal is signed so you can verify its authenticity. To authenticate, please send your login and then its signature.\" challenge_sig = priv.sign(int(hashlib.sha256(challenge.encode()).hexdigest(), 16), k) print(welcome) print((int(welcome_sig.r), int(welcome_sig.s))) print(challenge) print((int(challenge_sig.r), int(challenge_sig.s))) In this part of code, the server share the clear text and its corresponding signature twice. Now we know :\nClear text of the 2 messages. The corresponding hash. The corresponding signature pair. try: flag_sig = ecdsa.Signature(int(user_r), int(user_s)) except: print(\"This is not a valid signature!\") exit(1) if login != \"admin\": print(\"User not recognized.\") exit(1) elif pub.verifies(int(hashlib.sha256(login.encode()).hexdigest(), 16), flag_sig): with open(\"flag.txt\", \"r\") as flag: print(\"Welcome back, magistrate.\", flag.read()) else: print(\"The signature does not match.\") The end of the code is for the login validation. We are asked to provide the admin login with its signature.\nExploitation After analysis we can see that the code is vulnerable to the ECDSA Nonce reuse attack because of the variable k reused. On GitHub this exploit is available to recover the private key from :\n2 clear text messages. Their signature pair. Their SHA hash. The public order number. Guess what ? We have all of this informations. Once we have the private key we need one last argument to sign a message : the nonce. By studying the algorithm, we understand that is possible to recover the nonce with our known arguments, so we can modify the script to also calculate this variable. Let’s code the attack(order, (r1,s1), (r2,s2), messageHash1, messageHash2) function to recover private key and nonce.\ndef attack(publicKeyOrderInteger, signaturePair1, signaturePair2, messageHash1, messageHash2): r1 = signaturePair1[0] s1 = signaturePair1[1] r2 = signaturePair2[0] s2 = signaturePair2[1] #Convert Hex into Int L1 = int(messageHash1, 16) L2 = int(messageHash2, 16) # Calculate private key numerator = (((s2 * L1) % publicKeyOrderInteger) - ((s1 * L2) % publicKeyOrderInteger)) denominator = inverse_mod(r1 * ((s1 - s2) % publicKeyOrderInteger), publicKeyOrderInteger) privateKey = numerator * denominator % publicKeyOrderInteger # Calculate nonce valinv = inverse_mod( (s1-s2),publicKeyOrderInteger) k1rec = ((L1-L2) * valinv) % publicKeyOrderInteger return privateKey, k1rec Now that we recovered the private key and the nonce, we can create a function to sign our message.\ndef signWithKey(message ,priv, k): G = NIST256p.generator pub = G * priv pub = ecdsa.Public_key(G, pub) priv = ecdsa.Private_key(pub, priv) admin_sig = priv.sign(int(hashlib.sha256(message.encode()).hexdigest(), 16), k) return admin_sig Finally, we can create the main function where we’ll put arguments.\nif __name__ == \"__main__\": order = 115792089210356248762697446949407573529996955224135760342422259061068512044369 hash1 = \"65b7ef6c464da58105ca7076c89119139d433f0ebdcc046f299e6921eba90bcc\" hash2 = \"f04fd0051de354eedf18b99bbee00066ea7667941540726b1808002c24c7e49a\" r1 = 0 s1 = 0 r2 = 0 s2 = 0 priv, k = attack(order, (r1, s1),(r2,s2), hash1, hash2) signedMsg = signWithKey(\"admin\", priv, k) print(\"priv : \", priv) print(\"k : \", k) print(\"signedMsg : \", (signedMsg.r, signedMsg.s)) The order value is the result of :\nfrom ecdsa import NIST256p G = NIST256p.generator order = G.order() Hashs are the sha256 of messages, they can be obtained by :\nimport hashlib welcome = f\"Welcome to the magistrates' systems authentication portal. These systems contain confidential information. By authenticating, you accept our terms of usage and confidentiality policy.\" hash1 = hashlib.sha256(welcome.encode()).hexdigest() challenge = \"All the information in this portal is signed so you can verify its authenticity. To authenticate, please send your login and then its signature.\" hash2 = hashlib.sha256(challenge.encode()).hexdigest() The value of r1, s1, r2, s2 are not set because they depend of the current instance of the server. We’ll set them once we started communicate with the server.\nLet’s exploit the server.\n# Connect to the server, here I did it locally nc sie2op7ohko.hackday.fr 1339 # (74715625609153450006784562398401338361041931268443960948935108653912648590215, 2468655573544140328431636565113297934372317950998530865679863119809953872332) # (74715625609153450006784562398401338361041931268443960948935108653912648590215, 24955756864124908510619458250087107506174043125875670595453519724151088492454) # enter these values admin 74715625609153450006784562398401338361041931268443960948935108653912648590215 65393612466234935634254813737338317373797017522275120750020068769463899933198 # Welcome back, magistrate. HACKDAY{REDACTED} Simultany, run the exploit script to obtain values sended to the server.\n# Set values of r1, s1, r2 and s2 python3 exploit.py # signedMsg : (mpz(74715625609153450006784562398401338361041931268443960948935108653912648590215), mpz(65393612466234935634254813737338317373797017522275120750020068769463899933198)) Final script exploit.py :\n#! /usr/bin/python3 from ecdsa import NIST256p, ecdsa from ecdsa.util import sigdecode_string from ecdsa.numbertheory import inverse_mod import hashlib def attack(publicKeyOrderInteger, signaturePair1, signaturePair2, messageHash1, messageHash2): r1 = signaturePair1[0] s1 = signaturePair1[1] r2 = signaturePair2[0] s2 = signaturePair2[1] #Convert Hex into Int L1 = int(messageHash1, 16) L2 = int(messageHash2, 16) # Calculate private key numerator = (((s2 * L1) % publicKeyOrderInteger) - ((s1 * L2) % publicKeyOrderInteger)) denominator = inverse_mod(r1 * ((s1 - s2) % publicKeyOrderInteger), publicKeyOrderInteger) privateKey = numerator * denominator % publicKeyOrderInteger # Calculate nonce valinv = inverse_mod( (s1-s2),publicKeyOrderInteger) k1rec = ((L1-L2) * valinv) % publicKeyOrderInteger return privateKey, k1rec def signWithKey(message ,priv, k): G = NIST256p.generator pub = G * priv pub = ecdsa.Public_key(G, pub) priv = ecdsa.Private_key(pub, priv) admin_sig = priv.sign(int(hashlib.sha256(message.encode()).hexdigest(), 16), k) return admin_sig if __name__ == \"__main__\": order = 115792089210356248762697446949407573529996955224135760342422259061068512044369 hash1 = \"65b7ef6c464da58105ca7076c89119139d433f0ebdcc046f299e6921eba90bcc\" hash2 = \"f04fd0051de354eedf18b99bbee00066ea7667941540726b1808002c24c7e49a\" r1 = 74715625609153450006784562398401338361041931268443960948935108653912648590215 s1 = 2468655573544140328431636565113297934372317950998530865679863119809953872332 r2 = 74715625609153450006784562398401338361041931268443960948935108653912648590215 s2 = 24955756864124908510619458250087107506174043125875670595453519724151088492454 priv, k = attack(order, (r1, s1),(r2,s2), hash1, hash2) signedMsg = signWithKey(\"admin\", priv, k) print(\"priv : \", priv) print(\"k : \", k) print(\"signedMsg : \", (signedMsg.r, signedMsg.s)) Resources ECDSA Nonce reuse explanation GitHub ECDSA Nonce reuse attack sample ",
  "wordCount" : "1203",
  "inLanguage": "en",
  "datePublished": "2023-03-13T01:00:00Z",
  "dateModified": "2023-03-13T01:00:00Z",
  "author":{
    "@type": "Person",
    "name": "CyberKoopas"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.cyberkoopas.fr/posts/hackday-qualification/trusted2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "CyberKoopas",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.cyberkoopas.fr/favicon.ico"
    }
  }
}
</script>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.cyberkoopas.fr/" accesskey="h" title="CyberKoopas (Alt + H)">
                <img src="https://www.cyberkoopas.fr/avatar.jpeg" alt="" aria-label="logo"
                    height="30">CyberKoopas</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.cyberkoopas.fr/timeline/" title="Timeline">
                    <span>Timeline</span>
                </a>
            </li>
            <li>
                <a href="https://www.cyberkoopas.fr/categories/writeups/" title="Writeups">
                    <span>Writeups</span>
                </a>
            </li>
            <li>
                <a href="https://www.cyberkoopas.fr/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://www.cyberkoopas.fr/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      [Hackday qualif] Crypto - Trusted 2
    </h1>
    <div class="post-meta"><span title='2023-03-13 01:00:00 +0000 UTC'>March 13, 2023</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;



</div>
  </header> 
  <div class="post-content"><h2 id="challenge-information">Challenge information<a hidden class="anchor" aria-hidden="true" href="#challenge-information">#</a></h2>
<h3 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h3>
<p>Following the leak of an important database in the Sagittarius sector, it has been decided to rework the whole security of the information system.  <br>
Make sure that the authentication portal is this time secured as it should be.</p>
<h3 id="attached-files">Attached files<a hidden class="anchor" aria-hidden="true" href="#attached-files">#</a></h3>
<ul>
<li>server.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> randrange
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ecdsa <span style="color:#f92672">import</span> NIST256p, ecdsa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>G <span style="color:#f92672">=</span> NIST256p<span style="color:#f92672">.</span>generator
</span></span><span style="display:flex;"><span>order <span style="color:#f92672">=</span> G<span style="color:#f92672">.</span>order()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>priv <span style="color:#f92672">=</span> randrange(<span style="color:#ae81ff">1</span>, order)
</span></span><span style="display:flex;"><span>pub <span style="color:#f92672">=</span> G <span style="color:#f92672">*</span> priv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pub <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>Public_key(G, pub)
</span></span><span style="display:flex;"><span>priv <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>Private_key(pub, priv)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> randrange(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">127</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>banner <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> _____              _           _    ___    ___   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_   _|            | |         | |  |__ \  / _ \ 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | |_ __ _   _ ___| |_ ___  __| |     ) || | | |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | | &#39;__| | | / __| __/ _ \/ _` |    / / | | | |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | | |  | |_| \__ \ ||  __/ (_| |   / /_ | |_| |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  \_/_|   \__,_|___/\__\___|\__,_|  |____(_)___/ 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(banner)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>welcome <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Welcome to the magistrates&#39; systems authentication portal. These systems contain confidential information. By authenticating, you accept our terms of usage and confidentiality policy.&#34;</span>
</span></span><span style="display:flex;"><span>welcome_sig <span style="color:#f92672">=</span> priv<span style="color:#f92672">.</span>sign(int(hashlib<span style="color:#f92672">.</span>sha256(welcome<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>), k)
</span></span><span style="display:flex;"><span>challenge <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;All the information in this portal is signed so you can verify its authenticity. To authenticate, please send your login and then its signature.&#34;</span>
</span></span><span style="display:flex;"><span>challenge_sig <span style="color:#f92672">=</span> priv<span style="color:#f92672">.</span>sign(int(hashlib<span style="color:#f92672">.</span>sha256(challenge<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>), k)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(welcome)
</span></span><span style="display:flex;"><span>print((int(welcome_sig<span style="color:#f92672">.</span>r), int(welcome_sig<span style="color:#f92672">.</span>s)))
</span></span><span style="display:flex;"><span>print(challenge)
</span></span><span style="display:flex;"><span>print((int(challenge_sig<span style="color:#f92672">.</span>r), int(challenge_sig<span style="color:#f92672">.</span>s)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>login <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Login: &#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>user_r <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;r: &#34;</span>)
</span></span><span style="display:flex;"><span>user_s <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;s: &#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    flag_sig <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>Signature(int(user_r), int(user_s))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;This is not a valid signature!&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> login <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;admin&#34;</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;User not recognized.&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> pub<span style="color:#f92672">.</span>verifies(int(hashlib<span style="color:#f92672">.</span>sha256(login<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>), flag_sig):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;flag.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> flag:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Welcome back, magistrate.&#34;</span>, flag<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;The signature does not match.&#34;</span>)
</span></span></code></pre></div><h2 id="solution">Solution<a hidden class="anchor" aria-hidden="true" href="#solution">#</a></h2>
<h3 id="implementation-analysis">Implementation analysis<a hidden class="anchor" aria-hidden="true" href="#implementation-analysis">#</a></h3>
<p>Let&rsquo;s analyze what the server do.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> randrange
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ecdsa <span style="color:#f92672">import</span> NIST256p, ecdsa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>G <span style="color:#f92672">=</span> NIST256p<span style="color:#f92672">.</span>generator
</span></span><span style="display:flex;"><span>order <span style="color:#f92672">=</span> G<span style="color:#f92672">.</span>order()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>priv <span style="color:#f92672">=</span> randrange(<span style="color:#ae81ff">1</span>, order)
</span></span><span style="display:flex;"><span>pub <span style="color:#f92672">=</span> G <span style="color:#f92672">*</span> priv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pub <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>Public_key(G, pub)
</span></span><span style="display:flex;"><span>priv <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>Private_key(pub, priv)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> randrange(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">127</span>)
</span></span></code></pre></div><p>Here, we understand that the algorithm is <strong>ECDSA</strong>. There are :</p>
<ul>
<li>Random number : <code>priv</code>.</li>
<li>Random number : <code>k</code>.</li>
<li><code>pub</code> (we need <code>priv</code> to get it).</li>
<li>Public number : <code>order</code> (always the same).</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>welcome <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Welcome to the magistrates&#39; systems authentication portal. These systems contain confidential information. By authenticating, you accept our terms of usage and confidentiality policy.&#34;</span>
</span></span><span style="display:flex;"><span>welcome_sig <span style="color:#f92672">=</span> priv<span style="color:#f92672">.</span>sign(int(hashlib<span style="color:#f92672">.</span>sha256(welcome<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>), k)
</span></span><span style="display:flex;"><span>challenge <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;All the information in this portal is signed so you can verify its authenticity. To authenticate, please send your login and then its signature.&#34;</span>
</span></span><span style="display:flex;"><span>challenge_sig <span style="color:#f92672">=</span> priv<span style="color:#f92672">.</span>sign(int(hashlib<span style="color:#f92672">.</span>sha256(challenge<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>), k)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(welcome)
</span></span><span style="display:flex;"><span>print((int(welcome_sig<span style="color:#f92672">.</span>r), int(welcome_sig<span style="color:#f92672">.</span>s)))
</span></span><span style="display:flex;"><span>print(challenge)
</span></span><span style="display:flex;"><span>print((int(challenge_sig<span style="color:#f92672">.</span>r), int(challenge_sig<span style="color:#f92672">.</span>s)))
</span></span></code></pre></div><p>In this part of code, the server share the clear text and its corresponding signature twice. Now we know :</p>
<ul>
<li>Clear text of the 2 messages.</li>
<li>The corresponding hash.</li>
<li>The corresponding signature pair.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    flag_sig <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>Signature(int(user_r), int(user_s))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;This is not a valid signature!&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> login <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;admin&#34;</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;User not recognized.&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> pub<span style="color:#f92672">.</span>verifies(int(hashlib<span style="color:#f92672">.</span>sha256(login<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>), flag_sig):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;flag.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> flag:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Welcome back, magistrate.&#34;</span>, flag<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;The signature does not match.&#34;</span>)
</span></span></code></pre></div><p>The end of the code is for the login validation. We are asked to provide the <code>admin</code> login with its signature.</p>
<h3 id="exploitation">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation">#</a></h3>
<p>After analysis we can see that the code is vulnerable to the <em>ECDSA Nonce reuse attack</em> because of the variable <code>k</code> reused.  <br>
On GitHub <a href="https://github.com/Marsh61/ECDSA-Nonce-Reuse-Exploit-Example/blob/master/Attack-Main.py">this exploit</a> is available to recover the private key from :</p>
<ul>
<li>2 clear text messages.</li>
<li>Their signature pair.</li>
<li>Their SHA hash.</li>
<li>The public order number.</li>
</ul>
<p>Guess what ? We have all of this informations. Once we have the private key we need one last argument to sign a message : the nonce.  <br>
By studying the algorithm, we understand that is possible to recover the nonce with our known arguments, so we can modify the script to also calculate this variable. Let&rsquo;s code the <code>attack(order, (r1,s1), (r2,s2), messageHash1, messageHash2)</code> function to recover private key and nonce.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">attack</span>(publicKeyOrderInteger, signaturePair1, signaturePair2, messageHash1, messageHash2): 
</span></span><span style="display:flex;"><span>    r1 <span style="color:#f92672">=</span> signaturePair1[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    s1 <span style="color:#f92672">=</span> signaturePair1[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    r2 <span style="color:#f92672">=</span> signaturePair2[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    s2 <span style="color:#f92672">=</span> signaturePair2[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#Convert Hex into Int</span>
</span></span><span style="display:flex;"><span>    L1 <span style="color:#f92672">=</span> int(messageHash1, <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>    L2 <span style="color:#f92672">=</span> int(messageHash2, <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Calculate private key</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> (((s2 <span style="color:#f92672">*</span> L1) <span style="color:#f92672">%</span> publicKeyOrderInteger) <span style="color:#f92672">-</span> ((s1 <span style="color:#f92672">*</span> L2) <span style="color:#f92672">%</span> publicKeyOrderInteger))
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> inverse_mod(r1 <span style="color:#f92672">*</span> ((s1 <span style="color:#f92672">-</span> s2) <span style="color:#f92672">%</span> publicKeyOrderInteger), publicKeyOrderInteger)
</span></span><span style="display:flex;"><span>    privateKey <span style="color:#f92672">=</span> numerator <span style="color:#f92672">*</span> denominator <span style="color:#f92672">%</span> publicKeyOrderInteger
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Calculate nonce</span>
</span></span><span style="display:flex;"><span>    valinv <span style="color:#f92672">=</span> inverse_mod( (s1<span style="color:#f92672">-</span>s2),publicKeyOrderInteger)
</span></span><span style="display:flex;"><span>    k1rec <span style="color:#f92672">=</span> ((L1<span style="color:#f92672">-</span>L2) <span style="color:#f92672">*</span> valinv) <span style="color:#f92672">%</span> publicKeyOrderInteger
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> privateKey, k1rec
</span></span></code></pre></div><p>Now that we recovered the private key and the nonce, we can create a function to sign our message.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">signWithKey</span>(message ,priv, k):
</span></span><span style="display:flex;"><span>    G <span style="color:#f92672">=</span> NIST256p<span style="color:#f92672">.</span>generator
</span></span><span style="display:flex;"><span>    pub <span style="color:#f92672">=</span> G <span style="color:#f92672">*</span> priv
</span></span><span style="display:flex;"><span>    pub <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>Public_key(G, pub)
</span></span><span style="display:flex;"><span>    priv <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>Private_key(pub, priv)
</span></span><span style="display:flex;"><span>    admin_sig <span style="color:#f92672">=</span> priv<span style="color:#f92672">.</span>sign(int(hashlib<span style="color:#f92672">.</span>sha256(message<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>), k)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> admin_sig
</span></span></code></pre></div><p>Finally, we can create the main function where we&rsquo;ll put arguments.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    order <span style="color:#f92672">=</span> <span style="color:#ae81ff">115792089210356248762697446949407573529996955224135760342422259061068512044369</span>
</span></span><span style="display:flex;"><span>    hash1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;65b7ef6c464da58105ca7076c89119139d433f0ebdcc046f299e6921eba90bcc&#34;</span>
</span></span><span style="display:flex;"><span>    hash2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;f04fd0051de354eedf18b99bbee00066ea7667941540726b1808002c24c7e49a&#34;</span>
</span></span><span style="display:flex;"><span>    r1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    s1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    r2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    s2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    priv, k <span style="color:#f92672">=</span> attack(order, (r1, s1),(r2,s2), hash1, hash2)
</span></span><span style="display:flex;"><span>    signedMsg <span style="color:#f92672">=</span> signWithKey(<span style="color:#e6db74">&#34;admin&#34;</span>, priv, k)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;priv : &#34;</span>, priv)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;k : &#34;</span>, k)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;signedMsg : &#34;</span>, (signedMsg<span style="color:#f92672">.</span>r, signedMsg<span style="color:#f92672">.</span>s))
</span></span></code></pre></div><p>The order value is the result of :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> ecdsa <span style="color:#f92672">import</span> NIST256p
</span></span><span style="display:flex;"><span>G <span style="color:#f92672">=</span> NIST256p<span style="color:#f92672">.</span>generator
</span></span><span style="display:flex;"><span>order <span style="color:#f92672">=</span> G<span style="color:#f92672">.</span>order()
</span></span></code></pre></div><p>Hashs are the sha256 of messages, they can be obtained by :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span>welcome <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Welcome to the magistrates&#39; systems authentication portal. These systems contain confidential information. By authenticating, you accept our terms of usage and confidentiality policy.&#34;</span>
</span></span><span style="display:flex;"><span>hash1 <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha256(welcome<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest()
</span></span><span style="display:flex;"><span>challenge <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;All the information in this portal is signed so you can verify its authenticity. To authenticate, please send your login and then its signature.&#34;</span>
</span></span><span style="display:flex;"><span>hash2 <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha256(challenge<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest()
</span></span></code></pre></div><p>The value of <code>r1</code>, <code>s1</code>, <code>r2</code>, <code>s2</code> are not set because they depend of the current instance of the server. We&rsquo;ll set them once we started communicate with the server.</p>
<p>Let&rsquo;s exploit the server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Connect to the server, here I did it locally</span>
</span></span><span style="display:flex;"><span>nc sie2op7ohko.hackday.fr <span style="color:#ae81ff">1339</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (74715625609153450006784562398401338361041931268443960948935108653912648590215, 2468655573544140328431636565113297934372317950998530865679863119809953872332)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (74715625609153450006784562398401338361041931268443960948935108653912648590215, 24955756864124908510619458250087107506174043125875670595453519724151088492454)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># enter these values</span>
</span></span><span style="display:flex;"><span>admin
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">74715625609153450006784562398401338361041931268443960948935108653912648590215</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">65393612466234935634254813737338317373797017522275120750020068769463899933198</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Welcome back, magistrate. HACKDAY{REDACTED}</span>
</span></span></code></pre></div><p>Simultany, run the exploit script to obtain values sended to the server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Set values of r1, s1, r2 and s2</span>
</span></span><span style="display:flex;"><span>python3 exploit.py
</span></span><span style="display:flex;"><span><span style="color:#75715e"># signedMsg :  (mpz(74715625609153450006784562398401338361041931268443960948935108653912648590215), mpz(65393612466234935634254813737338317373797017522275120750020068769463899933198))</span>
</span></span></code></pre></div><p><img loading="lazy" src="/CTFs/Hackday-qualif/Crypto/Trusted2/proof.png" alt="Proof"  />
</p>
<h3 id="final-script">Final script<a hidden class="anchor" aria-hidden="true" href="#final-script">#</a></h3>
<p><em>exploit.py</em> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#! /usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ecdsa <span style="color:#f92672">import</span> NIST256p, ecdsa
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ecdsa.util <span style="color:#f92672">import</span> sigdecode_string
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ecdsa.numbertheory <span style="color:#f92672">import</span> inverse_mod
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">attack</span>(publicKeyOrderInteger, signaturePair1, signaturePair2, messageHash1, messageHash2): 
</span></span><span style="display:flex;"><span>    r1 <span style="color:#f92672">=</span> signaturePair1[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    s1 <span style="color:#f92672">=</span> signaturePair1[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    r2 <span style="color:#f92672">=</span> signaturePair2[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    s2 <span style="color:#f92672">=</span> signaturePair2[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#Convert Hex into Int</span>
</span></span><span style="display:flex;"><span>    L1 <span style="color:#f92672">=</span> int(messageHash1, <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>    L2 <span style="color:#f92672">=</span> int(messageHash2, <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Calculate private key</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> (((s2 <span style="color:#f92672">*</span> L1) <span style="color:#f92672">%</span> publicKeyOrderInteger) <span style="color:#f92672">-</span> ((s1 <span style="color:#f92672">*</span> L2) <span style="color:#f92672">%</span> publicKeyOrderInteger))
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> inverse_mod(r1 <span style="color:#f92672">*</span> ((s1 <span style="color:#f92672">-</span> s2) <span style="color:#f92672">%</span> publicKeyOrderInteger), publicKeyOrderInteger)
</span></span><span style="display:flex;"><span>    privateKey <span style="color:#f92672">=</span> numerator <span style="color:#f92672">*</span> denominator <span style="color:#f92672">%</span> publicKeyOrderInteger
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Calculate nonce</span>
</span></span><span style="display:flex;"><span>    valinv <span style="color:#f92672">=</span> inverse_mod( (s1<span style="color:#f92672">-</span>s2),publicKeyOrderInteger)
</span></span><span style="display:flex;"><span>    k1rec <span style="color:#f92672">=</span> ((L1<span style="color:#f92672">-</span>L2) <span style="color:#f92672">*</span> valinv) <span style="color:#f92672">%</span> publicKeyOrderInteger
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> privateKey, k1rec
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">signWithKey</span>(message ,priv, k):
</span></span><span style="display:flex;"><span>    G <span style="color:#f92672">=</span> NIST256p<span style="color:#f92672">.</span>generator
</span></span><span style="display:flex;"><span>    pub <span style="color:#f92672">=</span> G <span style="color:#f92672">*</span> priv
</span></span><span style="display:flex;"><span>    pub <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>Public_key(G, pub)
</span></span><span style="display:flex;"><span>    priv <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>Private_key(pub, priv)
</span></span><span style="display:flex;"><span>    admin_sig <span style="color:#f92672">=</span> priv<span style="color:#f92672">.</span>sign(int(hashlib<span style="color:#f92672">.</span>sha256(message<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>), k)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> admin_sig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    order <span style="color:#f92672">=</span> <span style="color:#ae81ff">115792089210356248762697446949407573529996955224135760342422259061068512044369</span>
</span></span><span style="display:flex;"><span>    hash1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;65b7ef6c464da58105ca7076c89119139d433f0ebdcc046f299e6921eba90bcc&#34;</span>
</span></span><span style="display:flex;"><span>    hash2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;f04fd0051de354eedf18b99bbee00066ea7667941540726b1808002c24c7e49a&#34;</span>
</span></span><span style="display:flex;"><span>    r1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">74715625609153450006784562398401338361041931268443960948935108653912648590215</span>
</span></span><span style="display:flex;"><span>    s1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2468655573544140328431636565113297934372317950998530865679863119809953872332</span>
</span></span><span style="display:flex;"><span>    r2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">74715625609153450006784562398401338361041931268443960948935108653912648590215</span>
</span></span><span style="display:flex;"><span>    s2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">24955756864124908510619458250087107506174043125875670595453519724151088492454</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    priv, k <span style="color:#f92672">=</span> attack(order, (r1, s1),(r2,s2), hash1, hash2)
</span></span><span style="display:flex;"><span>    signedMsg <span style="color:#f92672">=</span> signWithKey(<span style="color:#e6db74">&#34;admin&#34;</span>, priv, k)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;priv : &#34;</span>, priv)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;k : &#34;</span>, k)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;signedMsg : &#34;</span>, (signedMsg<span style="color:#f92672">.</span>r, signedMsg<span style="color:#f92672">.</span>s))
</span></span></code></pre></div><h3 id="resources">Resources<a hidden class="anchor" aria-hidden="true" href="#resources">#</a></h3>
<ul>
<li><a href="https://billatnapier.medium.com/ecdsa-weakness-where-nonces-are-reused-2be63856a01a">ECDSA Nonce reuse explanation</a></li>
<li><a href="https://github.com/Marsh61/ECDSA-Nonce-Reuse-Exploit-Example/blob/master/Attack-Main.py">GitHub ECDSA Nonce reuse attack sample</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://www.cyberkoopas.fr/tags/x-hackday-qualification/">x-hackday-qualification</a></li>
      <li><a href="https://www.cyberkoopas.fr/tags/crypto/">crypto</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; CyberKoopas | 2023</span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
