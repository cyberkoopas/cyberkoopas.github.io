<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[Midnight qualif] Crypto - M4g1c | CyberKoopas</title>
<meta name="keywords" content="x-Midnight-qualif, crypto">
<meta name="description" content="Challenge information Summary A file has been encrypted and we have access to the encryption algorithm.
Attached files encrypt.py import sys import os def get_key(length): return os.urandom(length) def encrypt(filename, key): filename_lock = filename &#43; &#34;.lock&#34; data = open(filename, &#34;rb&#34;).read() os.remove(filename) locked = open(filename_lock, &#34;wb&#34;) for idx, i in enumerate(data): locked.write((i ^ key[idx % len(key)]).to_bytes(1, &#34;big&#34;)) if __name__ == &#39;__main__&#39;: if len(sys.argv) != 2: print(f&#34;Usage: {sys.argv[0]} &lt;file to cipher&gt;&#34;) exit(0) else: key = get_key(12) encrypt(sys.">
<meta name="author" content="

">
<link rel="canonical" href="https://www.cyberkoopas.fr/posts/midnight/m4g1c/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css" integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://www.cyberkoopas.fr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.cyberkoopas.fr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.cyberkoopas.fr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://www.cyberkoopas.fr/apple-touch-icon.png">
<link rel="mask-icon" href="https://www.cyberkoopas.fr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="[Midnight qualif] Crypto - M4g1c" />
<meta property="og:description" content="Challenge information Summary A file has been encrypted and we have access to the encryption algorithm.
Attached files encrypt.py import sys import os def get_key(length): return os.urandom(length) def encrypt(filename, key): filename_lock = filename &#43; &#34;.lock&#34; data = open(filename, &#34;rb&#34;).read() os.remove(filename) locked = open(filename_lock, &#34;wb&#34;) for idx, i in enumerate(data): locked.write((i ^ key[idx % len(key)]).to_bytes(1, &#34;big&#34;)) if __name__ == &#39;__main__&#39;: if len(sys.argv) != 2: print(f&#34;Usage: {sys.argv[0]} &lt;file to cipher&gt;&#34;) exit(0) else: key = get_key(12) encrypt(sys." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cyberkoopas.fr/posts/midnight/m4g1c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-04-16T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[Midnight qualif] Crypto - M4g1c"/>
<meta name="twitter:description" content="Challenge information Summary A file has been encrypted and we have access to the encryption algorithm.
Attached files encrypt.py import sys import os def get_key(length): return os.urandom(length) def encrypt(filename, key): filename_lock = filename &#43; &#34;.lock&#34; data = open(filename, &#34;rb&#34;).read() os.remove(filename) locked = open(filename_lock, &#34;wb&#34;) for idx, i in enumerate(data): locked.write((i ^ key[idx % len(key)]).to_bytes(1, &#34;big&#34;)) if __name__ == &#39;__main__&#39;: if len(sys.argv) != 2: print(f&#34;Usage: {sys.argv[0]} &lt;file to cipher&gt;&#34;) exit(0) else: key = get_key(12) encrypt(sys."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://www.cyberkoopas.fr/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "[Midnight qualif] Crypto - M4g1c",
      "item": "https://www.cyberkoopas.fr/posts/midnight/m4g1c/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[Midnight qualif] Crypto - M4g1c",
  "name": "[Midnight qualif] Crypto - M4g1c",
  "description": "Challenge information Summary A file has been encrypted and we have access to the encryption algorithm.\nAttached files encrypt.py import sys import os def get_key(length): return os.urandom(length) def encrypt(filename, key): filename_lock = filename + \u0026#34;.lock\u0026#34; data = open(filename, \u0026#34;rb\u0026#34;).read() os.remove(filename) locked = open(filename_lock, \u0026#34;wb\u0026#34;) for idx, i in enumerate(data): locked.write((i ^ key[idx % len(key)]).to_bytes(1, \u0026#34;big\u0026#34;)) if __name__ == \u0026#39;__main__\u0026#39;: if len(sys.argv) != 2: print(f\u0026#34;Usage: {sys.argv[0]} \u0026lt;file to cipher\u0026gt;\u0026#34;) exit(0) else: key = get_key(12) encrypt(sys.",
  "keywords": [
    "x-Midnight-qualif", "crypto"
  ],
  "articleBody": "Challenge information Summary A file has been encrypted and we have access to the encryption algorithm.\nAttached files encrypt.py import sys import os def get_key(length): return os.urandom(length) def encrypt(filename, key): filename_lock = filename + \".lock\" data = open(filename, \"rb\").read() os.remove(filename) locked = open(filename_lock, \"wb\") for idx, i in enumerate(data): locked.write((i ^ key[idx % len(key)]).to_bytes(1, \"big\")) if __name__ == '__main__': if len(sys.argv) != 2: print(f\"Usage: {sys.argv[0]} \") exit(0) else: key = get_key(12) encrypt(sys.argv[1], key) print(\"File successfuly encrypted.\") flag.jpg.lock (chars not printables) Solution Implementation analysis Firstly, we can analyze the encryption script to understand how it works.\ndef get_key(length): return os.urandom(length) The encryption key is generated randomly.\ndef encrypt(filename, key): filename_lock = filename + \".lock\" data = open(filename, \"rb\").read() os.remove(filename) locked = open(filename_lock, \"wb\") for idx, i in enumerate(data): locked.write((i ^ key[idx % len(key)]).to_bytes(1, \"big\")) The encryption algorithm looks like a classic XOR encryption.\nkey = get_key(12) encrypt(sys.argv[1], key) print(\"File successfuly encrypted.\") The script encrypts the file using a generated 12-character key.\nExploitation We can found there a list of file signatures (starting bytes of a file). Or by analyzing the cyberkoopas logo. We can extract first 12 chars of logo, we will assume that these bytes are the originally flag.jpg.lock first 12 bytes.\nxxd -c 12 flag.jpg.lock | head -n 1 # 01b9 3227 b890 b696 887b f3e6 xxd -c 12 avatar.jpeg | head -n 1 # ffd8 ffe0 0010 4a46 4946 0001 We know for encrypt file using XOR we do this operation : data ^ key = encrypted_data. The XOR cipher is vulnerable to the Known-plaintext attack because we can use this operation to retrieve the key : encrypted_data ^ data = key. Here we only need to XOR the first 12 bytes to get the key and then decrypt the whole file. So the key is : 01b9 3227 b890 b696 887b f3e6 ^ ffd8 ffe0 0010 4a46 4946 0001 = fe61 cdc7 b880 fcd0 c13d f3e7. We can calculate it using Cyberchef.\nThen we can use the same script to decrypt the image by setting manually the key.\nimport sys import os def get_key(length): return b\"\\xfe\\x61\\xcd\\xc7\\xb8\\x80\\xfc\\xd0\\xc1\\x3d\\xf3\\xe7\" # HERE IS THE CHANGE def encrypt(filename, key): filename_lock = filename + \".lock\" data = open(filename, \"rb\").read() os.remove(filename) locked = open(filename_lock, \"wb\") for idx, i in enumerate(data): locked.write((i ^ key[idx % len(key)]).to_bytes(1, \"big\")) if __name__ == '__main__': if len(sys.argv) != 2: print(f\"Usage: {sys.argv[0]} \") exit(0) else: key = get_key(12) encrypt(sys.argv[1], key) print(\"File successfuly encrypted.\") Then run the script on flag.jpg.lock and the decrypted file will be flag.jpg.lock.lock.\npython3 encrypt.py flag.jpg.lock The flag is displayed once we open the decrypted image.\nFlag : ",
  "wordCount" : "435",
  "inLanguage": "en",
  "datePublished": "2023-04-16T00:00:00Z",
  "dateModified": "2023-04-16T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "CyberKoopas"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.cyberkoopas.fr/posts/midnight/m4g1c/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "CyberKoopas",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.cyberkoopas.fr/favicon.ico"
    }
  }
}
</script>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.cyberkoopas.fr/" accesskey="h" title="CyberKoopas (Alt + H)">
                <img src="https://www.cyberkoopas.fr/avatar.jpeg" alt="" aria-label="logo"
                    height="30">CyberKoopas</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.cyberkoopas.fr/timeline/" title="Timeline">
                    <span>Timeline</span>
                </a>
            </li>
            <li>
                <a href="https://www.cyberkoopas.fr/categories/writeups/" title="Writeups">
                    <span>Writeups</span>
                </a>
            </li>
            <li>
                <a href="https://www.cyberkoopas.fr/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      [Midnight qualif] Crypto - M4g1c
    </h1>
    <div class="post-meta"><span title='2023-04-16 00:00:00 +0000 UTC'>April 16, 2023</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;



</div>
  </header> 
  <div class="post-content"><h2 id="challenge-information">Challenge information<a hidden class="anchor" aria-hidden="true" href="#challenge-information">#</a></h2>
<h3 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h3>
<p>A file has been encrypted and we have access to the encryption algorithm.</p>
<h3 id="attached-files">Attached files<a hidden class="anchor" aria-hidden="true" href="#attached-files">#</a></h3>
<ul>
<li>encrypt.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(length):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> os<span style="color:#f92672">.</span>urandom(length)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encrypt</span>(filename, key):
</span></span><span style="display:flex;"><span>    filename_lock <span style="color:#f92672">=</span> filename <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.lock&#34;</span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> open(filename, <span style="color:#e6db74">&#34;rb&#34;</span>)<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>remove(filename)
</span></span><span style="display:flex;"><span>    locked <span style="color:#f92672">=</span> open(filename_lock, <span style="color:#e6db74">&#34;wb&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx, i <span style="color:#f92672">in</span> enumerate(data):
</span></span><span style="display:flex;"><span>        locked<span style="color:#f92672">.</span>write((i <span style="color:#f92672">^</span> key[idx <span style="color:#f92672">%</span> len(key)])<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;big&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Usage: </span><span style="color:#e6db74">{</span>sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">0</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> &lt;file to cipher&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> get_key(<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>        encrypt(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], key)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;File successfuly encrypted.&#34;</span>)
</span></span></code></pre></div><ul>
<li>flag.jpg.lock (chars not printables)</li>
</ul>
<h2 id="solution">Solution<a hidden class="anchor" aria-hidden="true" href="#solution">#</a></h2>
<h3 id="implementation-analysis">Implementation analysis<a hidden class="anchor" aria-hidden="true" href="#implementation-analysis">#</a></h3>
<p>Firstly, we can analyze the encryption script to understand how it works.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(length):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> os<span style="color:#f92672">.</span>urandom(length)
</span></span></code></pre></div><p>The encryption key is generated randomly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encrypt</span>(filename, key):
</span></span><span style="display:flex;"><span>    filename_lock <span style="color:#f92672">=</span> filename <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.lock&#34;</span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> open(filename, <span style="color:#e6db74">&#34;rb&#34;</span>)<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>remove(filename)
</span></span><span style="display:flex;"><span>    locked <span style="color:#f92672">=</span> open(filename_lock, <span style="color:#e6db74">&#34;wb&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx, i <span style="color:#f92672">in</span> enumerate(data):
</span></span><span style="display:flex;"><span>        locked<span style="color:#f92672">.</span>write((i <span style="color:#f92672">^</span> key[idx <span style="color:#f92672">%</span> len(key)])<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;big&#34;</span>))
</span></span></code></pre></div><p>The encryption algorithm looks like a classic XOR encryption.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> get_key(<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>    encrypt(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], key)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;File successfuly encrypted.&#34;</span>)
</span></span></code></pre></div><p>The script encrypts the file using a generated 12-character key.</p>
<h3 id="exploitation">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation">#</a></h3>
<p>We can found <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">there</a> a list of file signatures (starting bytes of a file).  <br>
Or by analyzing the <a href="https://www.cyberkoopas.fr/avatar.jpeg">cyberkoopas logo</a>. We can extract first 12 chars of logo, we will assume that these bytes are the originally flag.jpg.lock first 12 bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xxd -c <span style="color:#ae81ff">12</span> flag.jpg.lock | head -n <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 01b9 3227 b890 b696 887b f3e6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xxd -c <span style="color:#ae81ff">12</span> avatar.jpeg | head -n <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ffd8 ffe0 0010 4a46 4946 0001</span>
</span></span></code></pre></div><p><img loading="lazy" src="/CTFs/Midnight-qualif/Crypto/M4g1c/first-bytes.png" alt="First bytes"  />
</p>
<p>We know for encrypt file using XOR we do this operation : <code>data ^ key = encrypted_data</code>. The XOR cipher is vulnerable to the <em>Known-plaintext attack</em> because we can use this operation to retrieve the key : <code>encrypted_data ^ data = key</code>. Here we only need to XOR the first 12 bytes to get the key and then decrypt the whole file.  <br>
So the key is : <code>01b9 3227 b890 b696 887b f3e6 ^ ffd8 ffe0 0010 4a46 4946 0001 = fe61 cdc7 b880 fcd0 c13d f3e7</code>. We can calculate it using <a href="https://gchq.github.io/CyberChef/#recipe=From_Hex('Auto')XOR(%7B'option':'Hex','string':'ffd8%20ffe0%200010%204a46%204946%200001'%7D,'Standard',false)To_Hex('%5C%5Cx',0)&amp;input=MDFiOSAzMjI3IGI4OTAgYjY5NiA4ODdiIGYzZTY">Cyberchef</a>.</p>
<p><img loading="lazy" src="/CTFs/Midnight-qualif/Crypto/M4g1c/cyberchef.png" alt="First bytes"  />
</p>
<p>Then we can use the same script to decrypt the image by setting manually the key.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(length):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xfe\x61\xcd\xc7\xb8\x80\xfc\xd0\xc1\x3d\xf3\xe7</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># HERE IS THE CHANGE</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encrypt</span>(filename, key):
</span></span><span style="display:flex;"><span>    filename_lock <span style="color:#f92672">=</span> filename <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.lock&#34;</span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> open(filename, <span style="color:#e6db74">&#34;rb&#34;</span>)<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>remove(filename)
</span></span><span style="display:flex;"><span>    locked <span style="color:#f92672">=</span> open(filename_lock, <span style="color:#e6db74">&#34;wb&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx, i <span style="color:#f92672">in</span> enumerate(data):
</span></span><span style="display:flex;"><span>        locked<span style="color:#f92672">.</span>write((i <span style="color:#f92672">^</span> key[idx <span style="color:#f92672">%</span> len(key)])<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;big&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Usage: </span><span style="color:#e6db74">{</span>sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">0</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> &lt;file to cipher&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> get_key(<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>        encrypt(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], key)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;File successfuly encrypted.&#34;</span>)
</span></span></code></pre></div><p>Then run the script on <strong>flag.jpg.lock</strong> and the decrypted file will be <strong>flag.jpg.lock.lock</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python3 encrypt.py flag.jpg.lock
</span></span></code></pre></div><p>The flag is displayed once we open the decrypted image.</p>
<p><img loading="lazy" src="/CTFs/Midnight-qualif/Crypto/M4g1c/proof.png" alt="Script  execution"  />
</p>
<p>Flag :
<img loading="lazy" src="/CTFs/Midnight-qualif/Crypto/M4g1c/flag.jpg.lock.lock" alt="Flag"  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://www.cyberkoopas.fr/tags/x-midnight-qualif/">x-Midnight-qualif</a></li>
      <li><a href="https://www.cyberkoopas.fr/tags/crypto/">crypto</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; CyberKoopas | 2023</span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
